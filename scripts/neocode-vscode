#!/bin/bash

# NeoCode VSCode-like Session Script
# Creates a simple, reliable VSCode-like tmux layout
# Based on the AI recommendation for terminal-based VSCode experience

SESSION_NAME="neocode-dev"
PROJECT_DIR="${1:-$(pwd)}"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[NeoCode]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[Warning]${NC} $1"
}

error() {
    echo -e "${RED}[Error]${NC} $1"
}

# Check if tmux is available
if ! command -v tmux &> /dev/null; then
    error "tmux is not installed. Please install tmux first."
    exit 1
fi

# Check if session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    warning "Session '$SESSION_NAME' already exists."
    echo "Attaching to existing session..."
    tmux attach-session -t "$SESSION_NAME"
    exit 0
fi

log "Creating VSCode-like development environment..."
log "Project directory: $PROJECT_DIR"

# Step 1: Create new session
log "Creating tmux session '$SESSION_NAME'..."
tmux new-session -d -s "$SESSION_NAME" -c "$PROJECT_DIR"

# Step 2: Create the VSCode-like layout
# This follows the AI's recommended layout structure:
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ    File     ‚îÇ       Main Editor        ‚îÇ  Utility   ‚îÇ
# ‚îÇ   Explorer  ‚îÇ                          ‚îÇ   Panel    ‚îÇ
# ‚îÇ   (25%)     ‚îÇ        (55%)             ‚îÇ  (20%)     ‚îÇ
# ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
# ‚îÇ              Terminal / Output Area                 ‚îÇ
# ‚îÇ                    (30%)                            ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

# Rename the window
tmux rename-window -t "$SESSION_NAME:0" "NeoCode"

# Create left sidebar (25% width) - this will be pane 1, original becomes pane 0
log "Creating left sidebar for file explorer..."
tmux split-window -h -p 75 -t "$SESSION_NAME:0"

# Create right utility panel (20% of remaining width) - this creates pane 2
log "Creating right utility panel..."
tmux split-window -h -p 25 -t "$SESSION_NAME:0.0"

# Create bottom terminal (30% height) - split the main editor area
log "Creating bottom terminal area..."
tmux split-window -v -p 30 -t "$SESSION_NAME:0.0"

# Now we have 4 panes:
# 0: Main editor (top center)
# 1: Left sidebar (file explorer)  
# 2: Right utility panel
# 3: Bottom terminal

# Step 3: Setup each pane
log "Setting up file explorer..."
tmux send-keys -t "$SESSION_NAME:0.1" "clear" C-m
# Start nvim with file tree in left pane
tmux send-keys -t "$SESSION_NAME:0.1" "nvim -c 'NvimTreeOpen | only'" C-m

log "Setting up main editor..."
tmux send-keys -t "$SESSION_NAME:0.0" "clear" C-m
tmux send-keys -t "$SESSION_NAME:0.0" "nvim" C-m

log "Setting up utility panel..."
tmux send-keys -t "$SESSION_NAME:0.2" "clear" C-m
# Check if it's a git repo and show git status, otherwise just a shell
if [ -d "$PROJECT_DIR/.git" ]; then
    tmux send-keys -t "$SESSION_NAME:0.2" "git status && echo '' && echo 'Git repository detected. Use git commands here.'" C-m
else
    tmux send-keys -t "$SESSION_NAME:0.2" "echo 'Utility panel ready. You can run commands here.'" C-m
fi

log "Setting up terminal..."
tmux send-keys -t "$SESSION_NAME:0.3" "clear" C-m
tmux send-keys -t "$SESSION_NAME:0.3" "echo 'NeoCode terminal ready! üöÄ'" C-m

# Step 4: Set pane titles for clarity
tmux select-pane -t "$SESSION_NAME:0.0" -T "Editor"
tmux select-pane -t "$SESSION_NAME:0.1" -T "Explorer"
tmux select-pane -t "$SESSION_NAME:0.2" -T "Utility"
tmux select-pane -t "$SESSION_NAME:0.3" -T "Terminal"

# Step 5: Focus the main editor
tmux select-pane -t "$SESSION_NAME:0.0"

# Step 6: Load tmux config if it exists
if [ -f "$HOME/.config/neocode/tmux.conf" ]; then
    log "Loading NeoCode tmux configuration..."
    tmux source-file "$HOME/.config/neocode/tmux.conf" 2>/dev/null || warning "Could not load tmux config"
fi

log "VSCode-like environment created successfully!"
echo ""
echo "üéâ NeoCode Development Environment Ready!"
echo "üìÅ Project: $(basename "$PROJECT_DIR")"
echo ""
echo "‚å®Ô∏è  Navigation (with vim-tmux-navigator):"
echo "   Ctrl-h/j/k/l     - Move between panes seamlessly"
echo "   Alt-Arrow Keys   - Alternative pane navigation" 
echo "   Ctrl-a + |       - Split pane vertically"
echo "   Ctrl-a + -       - Split pane horizontally"
echo "   Ctrl-a + z       - Zoom/unzoom current pane"
echo ""
echo "üéØ Layout:"
echo "   Left:   File Explorer (nvim-tree)"
echo "   Center: Main Editor (Neovim)"
echo "   Right:  Utility Panel (git/commands)"
echo "   Bottom: Terminal"
echo ""
echo "üîß Tips:"
echo "   - Use <leader>e to toggle file explorer"
echo "   - Use Tab/Shift-Tab to switch between buffers"
echo "   - Use ':q' in Neovim to quit"
echo ""

# Step 7: Attach to session
log "Attaching to session..."
tmux attach-session -t "$SESSION_NAME"