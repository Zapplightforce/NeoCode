#!/bin/bash

# NeoCode Session Manager
# Creates a VSCode-like development environment using tmux and Neovim
#
# Layout:
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ             ‚îÇ                          ‚îÇ            ‚îÇ
# ‚îÇ    File     ‚îÇ       Main Editor        ‚îÇ  Utility   ‚îÇ
# ‚îÇ   Explorer  ‚îÇ                          ‚îÇ   Panel    ‚îÇ
# ‚îÇ   (20-25%)  ‚îÇ        (55-60%)          ‚îÇ  (15-20%)  ‚îÇ
# ‚îÇ             ‚îÇ                          ‚îÇ            ‚îÇ
# ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
# ‚îÇ                                                     ‚îÇ
# ‚îÇ              Terminal / Output Area                 ‚îÇ
# ‚îÇ                    (25-30%)                         ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

SESSION_NAME="neocode-dev"
PROJECT_DIR="${1:-$(pwd)}"

# Check if tmux is available
if ! command -v tmux &> /dev/null; then
    echo "‚ùå tmux is not installed. Please install tmux first."
    exit 1
fi

# Check if session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "üîÑ Session '$SESSION_NAME' already exists. Attaching..."
    tmux attach-session -t "$SESSION_NAME"
    exit 0
fi

echo "üöÄ Creating NeoCode development session..."

# Create new session (detached)
tmux new-session -d -s "$SESSION_NAME" -c "$PROJECT_DIR"

# Rename the first window
tmux rename-window -t "$SESSION_NAME:0" "NeoCode"

# Create the layout:
# 1. Split horizontally to create left sidebar (file explorer) - 25% width
tmux split-window -h -p 75 -t "$SESSION_NAME:0"

# 2. Split the right side to create right utility panel - 20% of remaining width
tmux split-window -h -p 25 -t "$SESSION_NAME:0.1"

# 3. Split the bottom to create terminal area - 30% height
tmux split-window -v -p 30 -t "$SESSION_NAME:0.1"

# Now we have 4 panes:
# 0: Left sidebar (file explorer)
# 1: Main editor 
# 2: Right utility panel
# 3: Bottom terminal

# Setup each pane:

# Pane 0: File Explorer (nvim-tree)
tmux send-keys -t "$SESSION_NAME:0.0" "nvim -c 'NvimTreeOpen | only'" C-m

# Pane 1: Main Editor (Neovim with welcome screen)
tmux send-keys -t "$SESSION_NAME:0.1" "nvim" C-m

# Pane 2: Utility Panel (can be git status, or another nvim instance)
tmux send-keys -t "$SESSION_NAME:0.2" "nvim -c 'terminal'" C-m

# Pane 3: Terminal
tmux send-keys -t "$SESSION_NAME:0.3" "echo 'üéØ NeoCode Terminal Ready'" C-m

# Focus the main editor pane
tmux select-pane -t "$SESSION_NAME:0.1"

# Set pane titles
tmux select-pane -t "$SESSION_NAME:0.0" -T "Explorer"
tmux select-pane -t "$SESSION_NAME:0.1" -T "Editor"  
tmux select-pane -t "$SESSION_NAME:0.2" -T "Utility"
tmux select-pane -t "$SESSION_NAME:0.3" -T "Terminal"

echo "‚úÖ NeoCode session created successfully!"
echo "üìÅ Project directory: $PROJECT_DIR"
echo "üéÆ Use Ctrl-h/j/k/l to navigate between panes"
echo "üîß Use <leader>e to toggle file explorer"
echo "üìã Use prefix + z to zoom/unzoom panes"

# Attach to the session
tmux attach-session -t "$SESSION_NAME"