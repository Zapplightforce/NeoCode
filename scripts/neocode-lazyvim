#!/bin/bash
# NeoCode with LazyVim - VSCode-like Session Manager

set -e

NEOCODE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_DIR="$NEOCODE_DIR/config"
SESSION_NAME="neocode"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[NeoCode]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check if LazyVim is available
check_lazyvim() {
    if [ ! -d "$HOME/.config/nvim" ]; then
        error "LazyVim not found! Please install LazyVim first:"
        echo ""
        echo "  git clone https://github.com/LazyVim/starter ~/.config/nvim"
        echo "  rm -rf ~/.config/nvim/.git"
        echo ""
        exit 1
    fi
    
    # Check Neovim version
    local nvim_version=$(nvim --version | head -n1 | grep -o 'v[0-9]\+\.[0-9]\+' | cut -c2-)
    if [ "$(printf '%s\n' "0.8.0" "$nvim_version" | sort -V | head -n1)" = "0.8.0" ]; then
        log "‚úÖ Neovim $nvim_version (compatible with LazyVim)"
    else
        warning "‚ö†Ô∏è  Neovim $nvim_version may not be fully compatible with LazyVim"
    fi
}

# Check dependencies
check_dependencies() {
    log "Checking dependencies..."
    
    local missing_deps=()
    
    command -v tmux &> /dev/null || missing_deps+=("tmux")
    command -v nvim &> /dev/null || missing_deps+=("neovim")
    command -v git &> /dev/null || missing_deps+=("git")
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        error "Missing dependencies: ${missing_deps[*]}"
        exit 1
    fi
    
    check_lazyvim
    log "All dependencies found ‚úì"
}

# Setup enhanced tmux configuration
setup_config() {
    log "Setting up enhanced tmux configuration..."
    
    mkdir -p "$HOME/.config/neocode"
    
    if [ -f "$CONFIG_DIR/tmux.conf" ]; then
        cp "$CONFIG_DIR/tmux.conf" "$HOME/.config/neocode/tmux.conf"
        log "‚úÖ Tmux configuration ready"
    fi
}

# Create VSCode-like session with LazyVim
start_session() {
    local project_dir="${1:-$(pwd)}"
    
    if [ "$#" -eq 0 ]; then
        echo ""
        echo "üìÅ Current directory: $(basename "$project_dir")"
        echo "   Full path: $project_dir" 
        echo ""
        read -p "üöÄ Open this directory with NeoCode + LazyVim? (y/n): " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            return 1
        fi
    fi
    
    log "Starting NeoCode with LazyVim in: $project_dir"
    
    # Check if session exists
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        warning "Session '$SESSION_NAME' already exists"
        echo "Attaching to existing session..."
        tmux attach-session -t "$SESSION_NAME"
        return
    fi
    
    log "Creating VSCode-like layout with LazyVim..."
    
    # Create session with LazyVim
    tmux new-session -d -s "$SESSION_NAME" -c "$project_dir"
    
    # Load tmux config
    if [ -f "$HOME/.config/neocode/tmux.conf" ]; then
        tmux source-file "$HOME/.config/neocode/tmux.conf" 2>/dev/null || true
    fi
    
    # Wait for session to be ready
    sleep 1
    
    # Get window reference
    local window=$(tmux list-windows -t "$SESSION_NAME" -F "#{window_index}" | head -n1)
    
    # Launch LazyVim with file explorer open
    log "Launching LazyVim..."
    tmux send-keys -t "$SESSION_NAME:$window" "nvim ." C-m
    
    # Wait for LazyVim to load
    sleep 3
    
    # Create bottom terminal pane (30% height)
    log "Setting up terminal panes..."
    tmux split-window -t "$SESSION_NAME:$window" -v -p 30 -c "$project_dir"
    
    # If git repo, create git pane
    if [ -d "$project_dir/.git" ]; then
        tmux split-window -h -p 50 -c "$project_dir"
        tmux send-keys "git status" C-m
        tmux select-pane -T "Git"
        tmux select-pane -L
        tmux select-pane -T "Terminal"
    else
        tmux select-pane -T "Terminal"
    fi
    
    # Focus back on LazyVim
    tmux select-pane -U
    tmux select-pane -T "LazyVim"
    
    # Rename window
    tmux rename-window -t "$SESSION_NAME:$window" "NeoCode"
    
    log "üéâ NeoCode with LazyVim ready!"
    echo ""
    echo "‚ú® LazyVim Features Available:"
    echo "   üìÅ File Explorer: <leader>e (Space + e)"
    echo "   üîç Find Files: <leader>ff (Space + f + f)" 
    echo "   üîé Live Grep: <leader>fg (Space + f + g)"
    echo "   üìã Buffers: <leader>fb (Space + f + b)"
    echo "   ‚ö° Command: <leader>fc (Space + f + c)"
    echo ""
    echo "üéØ Enhanced Navigation:"
    echo "   Ctrl+h/j/k/l    - Navigate between panes (vim + tmux)"
    echo "   Alt+Arrow Keys  - Navigate panes (alternative)"
    echo "   Ctrl+a + |      - Split vertically"
    echo "   Ctrl+a + -      - Split horizontally"
    echo ""
    echo "üö™ Exit: ':q' in LazyVim or 'exit' in terminal"
    echo ""
    
    # Attach to session
    tmux attach-session -t "$SESSION_NAME"
}

# Stop session
stop_session() {
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        tmux kill-session -t "$SESSION_NAME"
        log "NeoCode session stopped"
    else
        warning "No active NeoCode session found"
    fi
}

# List sessions
list_sessions() {
    log "Active tmux sessions:"
    tmux list-sessions 2>/dev/null || echo "No active sessions"
}

# Show help
show_help() {
    cat << EOF
üöÄ NeoCode with LazyVim - Modern VSCode-like Terminal Editor

Usage: $0 [COMMAND] [OPTIONS]

Commands:
    start [DIR]     Start NeoCode with LazyVim (default: current directory)
    stop           Stop the current NeoCode session
    attach         Attach to existing NeoCode session  
    list           List all active tmux sessions
    setup          Setup NeoCode configuration
    check          Check system dependencies
    help           Show this help message

LazyVim Features:
    üìÅ File Explorer      <leader>e (Space + e)
    üîç Find Files         <leader>ff (Space + f + f)
    üîé Live Grep          <leader>fg (Space + f + g) 
    üìã Buffers           <leader>fb (Space + f + b)
    ‚ö° Commands          <leader>fc (Space + f + c)
    üé® Colorschemes      <leader>uC (Space + u + C)
    
Examples:
    $0 start                    # Start in current directory
    $0 start /path/to/project   # Start in specific directory
    $0 stop                     # Stop current session

For more LazyVim help, press '?' in LazyVim or visit: https://lazyvim.org

EOF
}

# Main execution
main() {
    case "${1:-help}" in
        "start")
            check_dependencies
            setup_config
            start_session "$2"
            ;;
        "stop")
            stop_session
            ;;
        "attach")
            if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
                tmux attach-session -t "$SESSION_NAME"
            else
                error "No active NeoCode session found. Use '$0 start' to create one."
                exit 1
            fi
            ;;
        "list")
            list_sessions
            ;;
        "setup")
            check_dependencies
            setup_config
            log "NeoCode setup completed!"
            ;;
        "check")
            check_dependencies
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            error "Unknown command: $1"
            show_help
            exit 1
            ;;
    esac
}

main "$@"