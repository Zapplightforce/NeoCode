#!/bin/bash
# NeoCode Session Manager
# Creates and manages NeoCode editing sessions

set -e

NEOCODE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_DIR="$NEOCODE_DIR/config"
SESSION_NAME="neocode"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${GREEN}[NeoCode]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check dependencies
check_dependencies() {
    log "Checking dependencies..."
    
    local missing_deps=()
    
    if ! command -v tmux &> /dev/null; then
        missing_deps+=("tmux")
    fi
    
    if ! command -v nvim &> /dev/null; then
        missing_deps+=("neovim")
    fi
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        error "Missing dependencies: ${missing_deps[*]}"
        echo "Please install the missing dependencies and try again."
        exit 1
    fi
    
    log "All dependencies found âœ“"
}

# Setup NeoCode configuration
setup_config() {
    log "Setting up NeoCode configuration..."
    
    # Create config directories
    mkdir -p "$HOME/.config/neocode"
    mkdir -p "$HOME/.local/share/neocode"
    
    # Copy configuration files
    if [ -f "$CONFIG_DIR/tmux.conf" ]; then
        cp "$CONFIG_DIR/tmux.conf" "$HOME/.config/neocode/tmux.conf"
        log "Copied tmux configuration"
    fi
    
    # Create symlink for Neovim config
    if [ ! -L "$HOME/.config/neocode/init.lua" ]; then
        ln -sf "$NEOCODE_DIR/init.lua" "$HOME/.config/neocode/init.lua"
        log "Created Neovim configuration symlink"
    fi
    
    # Create lua directory symlink
    if [ ! -L "$HOME/.config/neocode/lua" ]; then
        ln -sf "$NEOCODE_DIR/lua" "$HOME/.config/neocode/lua"
        log "Created lua directory symlink"
    fi
}

# Start NeoCode session
start_session() {
    local project_dir="${1:-$(pwd)}"
    
    log "Starting NeoCode session in: $project_dir"
    
    # Check if session already exists
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        warning "Session '$SESSION_NAME' already exists"
        echo "Attaching to existing session..."
        tmux attach-session -t "$SESSION_NAME"
        return
    fi
    
    # Create new session
    tmux new-session -d -s "$SESSION_NAME" -c "$project_dir"
    
    # Load tmux configuration
    tmux source-file "$HOME/.config/neocode/tmux.conf"
    
    # Setup initial layout
    # Window 1: Main editor
    tmux rename-window -t "$SESSION_NAME:1" "Editor"
    tmux send-keys -t "$SESSION_NAME:1" "nvim -u ~/.config/neocode/init.lua ." C-m
    
    # Window 2: Terminal
    tmux new-window -t "$SESSION_NAME" -n "Terminal" -c "$project_dir"
    
    # Window 3: Git/Tools
    tmux new-window -t "$SESSION_NAME" -n "Git" -c "$project_dir"
    tmux send-keys -t "$SESSION_NAME:3" "git status" C-m
    
    # Focus on editor window
    tmux select-window -t "$SESSION_NAME:1"
    
    log "NeoCode session created successfully!"
    
    # Attach to session
    tmux attach-session -t "$SESSION_NAME"
}

# Stop NeoCode session
stop_session() {
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        tmux kill-session -t "$SESSION_NAME"
        log "NeoCode session stopped"
    else
        warning "No active NeoCode session found"
    fi
}

# List active sessions
list_sessions() {
    log "Active tmux sessions:"
    tmux list-sessions 2>/dev/null || echo "No active sessions"
}

# Show help
show_help() {
    cat << EOF
NeoCode Session Manager

Usage: $0 [COMMAND] [OPTIONS]

Commands:
    start [DIR]     Start a new NeoCode session (default: current directory)
    stop           Stop the current NeoCode session
    attach         Attach to existing NeoCode session
    list           List all active tmux sessions
    setup          Setup NeoCode configuration
    check          Check system dependencies
    help           Show this help message

Examples:
    $0 start /path/to/project    # Start session in specific directory
    $0 start                     # Start session in current directory
    $0 stop                      # Stop current session
    $0 attach                    # Attach to existing session

EOF
}

# Main execution
main() {
    case "${1:-help}" in
        "start")
            check_dependencies
            setup_config
            start_session "$2"
            ;;
        "stop")
            stop_session
            ;;
        "attach")
            if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
                tmux attach-session -t "$SESSION_NAME"
            else
                error "No active NeoCode session found. Use '$0 start' to create one."
                exit 1
            fi
            ;;
        "list")
            list_sessions
            ;;
        "setup")
            check_dependencies
            setup_config
            log "NeoCode setup completed!"
            ;;
        "check")
            check_dependencies
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            error "Unknown command: $1"
            show_help
            exit 1
            ;;
    esac
}

main "$@"