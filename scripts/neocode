#!/bin/bash
# NeoCode with LazyVim - VSCode-like Session Manager

set -e

NEOCODE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_DIR="$NEOCODE_DIR/config"
SESSION_NAME="neocode"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[NeoCode]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check if LazyVim is available
check_lazyvim() {
    if [ ! -d "$HOME/.config/nvim" ]; then
        error "LazyVim not found! Please install LazyVim first:"
        echo ""
        echo "  git clone https://github.com/LazyVim/starter ~/.config/nvim"
        echo "  rm -rf ~/.config/nvim/.git"
        echo ""
        exit 1
    fi
    
    # Check Neovim version
    local nvim_version=$(nvim --version | head -n1 | grep -o 'v[0-9]\+\.[0-9]\+' | cut -c2-)
    if [ "$(printf '%s\n' "0.8.0" "$nvim_version" | sort -V | head -n1)" = "0.8.0" ]; then
        log "âœ… Neovim $nvim_version (compatible with LazyVim)"
    else
        warning "âš ï¸  Neovim $nvim_version may not be fully compatible with LazyVim"
    fi
}

# Check dependencies
check_dependencies() {
    log "Checking dependencies..."
    
    local missing_deps=()
    
    command -v tmux &> /dev/null || missing_deps+=("tmux")
    command -v nvim &> /dev/null || missing_deps+=("neovim")
    command -v git &> /dev/null || missing_deps+=("git")
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        error "Missing dependencies: ${missing_deps[*]}"
        exit 1
    fi
    
    check_lazyvim
    log "All dependencies found âœ“"
}

# Setup enhanced tmux configuration
setup_config() {
    log "Setting up enhanced tmux configuration..."
    
    mkdir -p "$HOME/.config/neocode"
    
    if [ -f "$CONFIG_DIR/tmux.conf" ]; then
        cp "$CONFIG_DIR/tmux.conf" "$HOME/.config/neocode/tmux.conf"
        log "âœ… Tmux configuration ready"
    fi
}

# Enhanced directory selection with user prompts
# Returns the selected directory path via a global variable to avoid stdout pollution
select_project_directory() {
    local current_dir="$(pwd)"
    SELECTED_DIR=""
    
    while true; do
        echo "" >&2
        echo "ğŸš€ Welcome to NeoCode with LazyVim!" >&2
        echo "" >&2
        echo "ğŸ“ Current directory: $(basename "$current_dir")" >&2
        echo "   Full path: $current_dir" >&2
        echo "" >&2
        echo "Choose an option:" >&2
        echo "  [1] Open current directory" >&2
        echo "  [2] Choose different directory" >&2
        echo "  [3] Cancel" >&2
        echo "" >&2
        
        read -r -p "Enter your choice [1-3]: " choice
        
        case $choice in
            1|y|Y)
                echo "" >&2
                echo "âœ… Using current directory: $current_dir" >&2
                SELECTED_DIR="$current_dir"
                return 0
                ;;
            2|d|D)
                while true; do
                    echo "" >&2
                    read -r -p "ğŸ“‚ Enter directory path: " custom_dir
                    
                    # Handle empty input
                    if [ -z "$custom_dir" ]; then
                        echo "" >&2
                        echo "âŒ No path entered." >&2
                        read -r -s -p "Press Enter to go back to menu..."
                        echo "" >&2
                        break  # Go back to main menu
                    fi
                    
                    # Expand tilde and resolve path
                    custom_dir="${custom_dir/#\~/$HOME}"
                    
                    # Check if directory exists
                    if [ -d "$custom_dir" ]; then
                        # Convert to absolute path
                        local abs_dir
                        abs_dir=$(cd "$custom_dir" && pwd) || abs_dir="$custom_dir"
                        echo "" >&2
                        echo "âœ… Using directory: $abs_dir" >&2
                        SELECTED_DIR="$abs_dir"
                        return 0
                    else
                        echo "" >&2
                        echo "âŒ Directory does not exist: $custom_dir" >&2
                        read -r -p "Try again? [y/n]: " retry
                        if [[ ! "$retry" =~ ^[yY]$ ]]; then
                            echo "" >&2
                            break  # Go back to main menu
                        fi
                    fi
                done
                ;;
            3|n|N|q|Q)
                echo "" >&2
                echo "âŒ Cancelled by user." >&2
                return 1
                ;;
            *)
                echo "" >&2
                echo "âŒ Invalid choice. Please enter 1, 2, or 3." >&2
                read -r -s -p "Press Enter to continue..."
                echo "" >&2
                ;;
        esac
    done
}

# Create tmux session with stock LazyVim
start_session() {
    local project_dir="$1"
    
    # If no directory specified, let user choose
    if [ -z "$project_dir" ]; then
        select_project_directory
        local exit_code=$?
        if [ $exit_code -ne 0 ] || [ -z "$SELECTED_DIR" ]; then
            echo ""
            echo "Startup cancelled."
            return 1
        fi
        project_dir="$SELECTED_DIR"
    else
        # If directory was passed as argument, validate and convert to absolute path
        if [ ! -d "$project_dir" ]; then
            error "Directory does not exist: $project_dir"
            return 1
        fi
        # Convert to absolute path using cd
        project_dir=$(cd "$project_dir" && pwd) || {
            error "Failed to resolve directory: $project_dir"
            return 1
        }
    fi
    
    log "Starting NeoCode with LazyVim in: $project_dir"
    
    # Check if session exists
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        warning "Session '$SESSION_NAME' already exists"
        echo ""
        echo "Choose an option:"
        echo "  [a] Attach to existing session"
        echo "  [k] Kill existing session and create new one"
        echo "  [c] Cancel"
        echo ""
        read -p "Enter your choice [a/k/c]: " existing_choice
        echo ""
        
        case $existing_choice in
            a|A)
                log "Attaching to existing session..."
                tmux attach-session -t "$SESSION_NAME"
                return
                ;;
            k|K)
                tmux kill-session -t "$SESSION_NAME"
                log "Killed existing session"
                ;;
            c|C|*)
                echo "Cancelled."
                return 1
                ;;
        esac
    fi
    
    log "Creating tmux session with stock LazyVim..."
    
    # Fix git safe.directory issue for Docker volumes
    if [ -d "$project_dir/.git" ]; then
        log "Configuring git safe.directory..."
        git config --global --add safe.directory "$project_dir" 2>/dev/null || true
    fi
    
    # Create session with stock LazyVim
    tmux new-session -d -s "$SESSION_NAME" -c "$project_dir"
    
    # Load tmux config
    if [ -f "$HOME/.config/neocode/tmux.conf" ]; then
        tmux source-file "$HOME/.config/neocode/tmux.conf" 2>/dev/null || true
    fi
    
    # Wait for session to be ready
    sleep 1
    
    # Get window reference
    local window=$(tmux list-windows -t "$SESSION_NAME" -F "#{window_index}" | head -n1)
    
    # Launch stock LazyVim
    log "Launching LazyVim..."
    tmux send-keys -t "$SESSION_NAME:$window" "cd '$project_dir' && nvim ." C-m
    
    # Wait for LazyVim to initialize
    sleep 2
    
    # Create bottom terminal pane (30% height)
    log "Setting up terminal panes..."
    tmux split-window -t "$SESSION_NAME:$window" -v -p 30 -c "$project_dir"
    
    # If git repo, create git pane
    if [ -d "$project_dir/.git" ]; then
        tmux split-window -h -p 50 -c "$project_dir"
        tmux send-keys "git status" C-m
        tmux select-pane -T "Git"
        tmux select-pane -L
        tmux select-pane -T "Terminal"
    else
        tmux select-pane -T "Terminal"
    fi
    
    # Focus back on LazyVim
    tmux select-pane -U
    tmux select-pane -T "LazyVim"
    
    # Rename window
    tmux rename-window -t "$SESSION_NAME:$window" "NeoCode"
    
    log "ğŸ‰ NeoCode with LazyVim ready!"
    echo ""
    echo "âœ¨ LazyVim Shortcuts:"
    echo "   ğŸ” Find Files:     Space + Space or Space + ff"
    echo "   ğŸ” Find in Files:  Space + sg"
    echo "   ï¿½ File Explorer:  Space + e"
    echo "   ğŸ“‹ Buffers:        Space + fb"
    echo ""
    echo "ğŸ¯ Navigation:"
    echo "   Ctrl+h/j/k/l    - Navigate between tmux panes and nvim windows"
    echo "   Alt+Arrow Keys  - Alternative pane navigation"
    echo "   Ctrl+a + |      - Split tmux pane vertically"
    echo "   Ctrl+a + -      - Split tmux pane horizontally"
    if [ -d "$project_dir/.git" ]; then
        echo ""
        echo "ğŸ“¦ Git Repository:"
        echo "   â€¢ Git status in bottom-right pane"
    fi
    echo ""
    echo "ï¿½ Using stock LazyVim - see lazyvim.org for more shortcuts"
    echo ""
    
    # Attach to session
    tmux attach-session -t "$SESSION_NAME"
}

# Stop session
stop_session() {
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        tmux kill-session -t "$SESSION_NAME"
        log "NeoCode session stopped"
    else
        warning "No active NeoCode session found"
    fi
}

# List sessions
list_sessions() {
    log "Active tmux sessions:"
    tmux list-sessions 2>/dev/null || echo "No active sessions"
}

# Show help
show_help() {
    cat << EOF
ğŸš€ NeoCode with LazyVim - Modern VSCode-like Terminal Editor

Usage: $0 [COMMAND] [OPTIONS]

Commands:
    start [DIR]     Start NeoCode with LazyVim (default: current directory)
    stop           Stop the current NeoCode session
    attach         Attach to existing NeoCode session  
    list           List all active tmux sessions
    setup          Setup NeoCode configuration
    check          Check system dependencies
    help           Show this help message

LazyVim Features:
    ğŸ“ File Explorer      <leader>e (Space + e)
    ğŸ” Find Files         <leader>ff (Space + f + f)
    ğŸ” Live Grep          <leader>fg (Space + f + g) 
    ğŸ“‹ Buffers           <leader>fb (Space + f + b)
    âš¡ Commands          <leader>fc (Space + f + c)
    ğŸ¨ Colorschemes      <leader>uC (Space + u + C)
    
Examples:
    $0 start                    # Start in current directory
    $0 start /path/to/project   # Start in specific directory
    $0 stop                     # Stop current session

For more LazyVim help, press '?' in LazyVim or visit: https://lazyvim.org

EOF
}

# Main execution
main() {
    case "${1:-start}" in
        "start")
            check_dependencies
            setup_config
            start_session "$2"
            ;;
        "stop")
            stop_session
            ;;
        "attach")
            if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
                tmux attach-session -t "$SESSION_NAME"
            else
                error "No active NeoCode session found. Use '$0 start' to create one."
                exit 1
            fi
            ;;
        "list")
            list_sessions
            ;;
        "setup")
            check_dependencies
            setup_config
            log "NeoCode setup completed!"
            ;;
        "check")
            check_dependencies
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            # If an unknown argument is passed, treat it as a directory for start
            if [ -d "$1" ]; then
                check_dependencies
                setup_config
                start_session "$1"
            else
                error "Unknown command: $1"
                show_help
                exit 1
            fi
            ;;
    esac
}

main "$@"