#!/usr/bin/env bash

# NeoCode Enhanced VSCode-like Session Script
# Implements research-based improvements for optimal VSCode-like UX

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[NeoCode]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[NeoCode]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[NeoCode]${NC} $1"
}

print_error() {
    echo -e "${RED}[NeoCode]${NC} $1"
}

# Enhanced VSCode-like session with research improvements
create_vscode_layout() {
    local session_name="${1:-neocode}"
    
    print_status "Creating enhanced VSCode-like layout with research improvements..."
    
    # Check if session exists
    if tmux has-session -t "$session_name" 2>/dev/null; then
        print_status "Session '$session_name' exists. Attaching..."
        tmux attach-session -t "$session_name"
        return
    fi
    
    print_status "Creating new enhanced session: $session_name"
    
    # Create new session with enhanced layout
    tmux new-session -d -s "$session_name" -x 120 -y 30
    
    print_status "Setting up VSCode-like panes with research improvements..."
    
    # Main window: VSCode layout
    # Split horizontally first (top 70%, bottom 30% for terminal)
    tmux split-window -h -t "$session_name:0" -p 75
    
    # Split the left pane vertically (25% for file explorer, 75% for editor)
    tmux split-pane -v -t "$session_name:0.0" -p 30
    
    # Split the bottom-right for terminal area
    tmux split-pane -v -t "$session_name:0.1" -p 30
    
    print_status "Configuring pane contents..."
    
    # Pane 0: File explorer (nvim-tree via nvim)
    tmux send-keys -t "$session_name:0.0" "nvim +\"lua require('nvim-tree.api').tree.open()\"" Enter
    
    # Pane 1: Main editor
    tmux send-keys -t "$session_name:0.1" "nvim" Enter
    
    # Pane 2: Terminal (primary)
    tmux send-keys -t "$session_name:0.2" "clear" Enter
    
    # Pane 3: Secondary terminal/tools
    tmux send-keys -t "$session_name:0.3" "clear" Enter
    
    # Focus the main editor pane
    tmux select-pane -t "$session_name:0.1"
    
    # Set window name
    tmux rename-window -t "$session_name:0" "NeoCode-VSCode"
    
    # Create additional windows for enhanced workflow
    print_status "Setting up additional workspace windows..."
    
    # Git window
    tmux new-window -t "$session_name" -n "Git"
    tmux send-keys -t "$session_name:Git" "git status" Enter
    
    # Debug/Tasks window  
    tmux new-window -t "$session_name" -n "Tasks"
    tmux send-keys -t "$session_name:Tasks" "echo 'Task/Debug workspace ready'" Enter
    
    # Terminal-only window for system tasks
    tmux new-window -t "$session_name" -n "Terminal"
    
    # Return to main window
    tmux select-window -t "$session_name:0"
    
    print_success "Enhanced VSCode-like session created successfully!"
    print_status "Layout: File Explorer (25%) | Editor (45%) | Tools (30%)"
    print_status "Bottom: Primary Terminal (70%) | Secondary Terminal (30%)"
    
    # Show helpful information
    print_status "Enhanced VSCode-like keybindings available:"
    echo -e "  ${GREEN}Ctrl+h/j/k/l${NC}    - Navigate panes seamlessly"
    echo -e "  ${GREEN}Ctrl+b${NC}           - Toggle file explorer"
    echo -e "  ${GREEN}Ctrl+\`${NC}           - Toggle terminal"
    echo -e "  ${GREEN}Ctrl+p${NC}           - Quick file open"
    echo -e "  ${GREEN}Ctrl+Shift+f${NC}     - Find in files"
    echo -e "  ${GREEN}Ctrl+Tab${NC}         - Cycle buffers/tabs"
    echo -e "  ${GREEN}F4${NC}               - Quick terminal"
    
    # Attach to session
    tmux attach-session -t "$session_name"
}

# Enhanced debugging with research insights
debug_layout() {
    local session_name="${1:-debug}"
    
    print_status "Creating debug session with enhanced diagnostics..."
    
    if tmux has-session -t "$session_name" 2>/dev/null; then
        tmux kill-session -t "$session_name"
    fi
    
    tmux new-session -d -s "$session_name"
    
    print_status "Testing pane creation with research-based patterns..."
    
    # Test each split with validation
    tmux split-window -h -t "$session_name:0"
    tmux list-panes -t "$session_name:0" -F "Pane #{pane_index}: #{pane_width}x#{pane_height}"
    
    tmux split-pane -v -t "$session_name:0.0" -p 30
    tmux list-panes -t "$session_name:0" -F "Pane #{pane_index}: #{pane_width}x#{pane_height}"
    
    tmux split-pane -v -t "$session_name:0.1" -p 30
    tmux list-panes -t "$session_name:0" -F "Pane #{pane_index}: #{pane_width}x#{pane_height}"
    
    print_success "Debug layout created and validated!"
    
    tmux attach-session -t "$session_name"
}

# Main execution
main() {
    print_status "Starting NeoCode Enhanced VSCode Session..."
    
    case "${1:-}" in
        "debug")
            debug_layout "$2"
            ;;
        "vscode"|"")
            create_vscode_layout "$2"
            ;;
        "help"|"-h"|"--help")
            echo "NeoCode Enhanced Session Manager"
            echo ""
            echo "Usage: $0 [command] [session_name]"
            echo ""
            echo "Commands:"
            echo "  vscode    Create enhanced VSCode-like layout (default)"
            echo "  debug     Create debug layout for testing"
            echo "  help      Show this help message"
            echo ""
            echo "Examples:"
            echo "  $0                    # Create default VSCode session"
            echo "  $0 vscode myproject   # Create named VSCode session"
            echo "  $0 debug              # Create debug session"
            ;;
        *)
            print_error "Unknown command: $1"
            print_status "Use '$0 help' for usage information"
            exit 1
            ;;
    esac
}

# Verify dependencies
check_dependencies() {
    local missing_deps=()
    
    command -v tmux >/dev/null 2>&1 || missing_deps+=("tmux")
    command -v nvim >/dev/null 2>&1 || missing_deps+=("neovim")
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        print_error "Missing dependencies: ${missing_deps[*]}"
        print_status "Please install missing dependencies and try again"
        exit 1
    fi
}

# Check dependencies first
check_dependencies

# Run main function with all arguments
main "$@"