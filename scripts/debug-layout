#!/bin/bash

# NeoCode Tmux Layout Debug Script
# Helps debug tmux pane creation and layout issues

SESSION_NAME="neocode-debug"
PROJECT_DIR="${1:-$(pwd)}"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[Debug]${NC} $1"
}

info() {
    echo -e "${BLUE}[Info]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[Warning]${NC} $1"
}

# Clean up any existing debug session
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    warning "Killing existing debug session..."
    tmux kill-session -t "$SESSION_NAME"
fi

log "Creating debug session to test tmux layout..."

# Step 1: Create session
tmux new-session -d -s "$SESSION_NAME" -c "$PROJECT_DIR"
info "✓ Created session: $SESSION_NAME"

# Step 2: Show initial state
log "Initial state:"
tmux list-panes -t "$SESSION_NAME" -F "Pane #{pane_index}: #{pane_width}x#{pane_height} #{pane_title}"

# Step 3: Create first split (horizontal, 75% remaining = 25% for left pane)
log "Creating left sidebar (25% width)..."
tmux split-window -h -p 75 -t "$SESSION_NAME:0"
info "✓ Created left sidebar"

log "After first split:"
tmux list-panes -t "$SESSION_NAME" -F "Pane #{pane_index}: #{pane_width}x#{pane_height} #{pane_title}"

# Step 4: Create right panel (25% of remaining 75% = ~20% total)
log "Creating right utility panel..."
tmux split-window -h -p 25 -t "$SESSION_NAME:0.0"
info "✓ Created right panel"

log "After second split:"
tmux list-panes -t "$SESSION_NAME" -F "Pane #{pane_index}: #{pane_width}x#{pane_height} #{pane_title}"

# Step 5: Create bottom terminal
log "Creating bottom terminal (30% height)..."
tmux split-window -v -p 30 -t "$SESSION_NAME:0.0"
info "✓ Created bottom terminal"

log "Final layout:"
tmux list-panes -t "$SESSION_NAME" -F "Pane #{pane_index}: #{pane_width}x#{pane_height} #{pane_title} [#{pane_current_command}]"

# Step 6: Test each pane
log "Testing each pane..."

# Test pane 0 (main editor area)
log "Testing pane 0 (main editor)..."
tmux send-keys -t "$SESSION_NAME:0.0" "echo 'Pane 0: Main Editor Area'" C-m

# Test pane 1 (left sidebar)
log "Testing pane 1 (left sidebar)..."
tmux send-keys -t "$SESSION_NAME:0.1" "echo 'Pane 1: Left Sidebar (File Explorer)'" C-m

# Test pane 2 (right utility)
log "Testing pane 2 (right utility)..."
tmux send-keys -t "$SESSION_NAME:0.2" "echo 'Pane 2: Right Utility Panel'" C-m

# Test pane 3 (bottom terminal)
log "Testing pane 3 (bottom terminal)..."
tmux send-keys -t "$SESSION_NAME:0.3" "echo 'Pane 3: Bottom Terminal'" C-m

# Step 7: Set titles
log "Setting pane titles..."
tmux select-pane -t "$SESSION_NAME:0.0" -T "Main-Editor"
tmux select-pane -t "$SESSION_NAME:0.1" -T "File-Explorer"  
tmux select-pane -t "$SESSION_NAME:0.2" -T "Utility-Panel"
tmux select-pane -t "$SESSION_NAME:0.3" -T "Terminal"

# Step 8: Show final result
log "Final pane information:"
tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}: #{pane_title} (#{pane_width}x#{pane_height}) - #{pane_current_command}"

# Step 9: Show layout info
log "Layout information:"
tmux list-windows -t "$SESSION_NAME" -F "Window #{window_index}: #{window_layout}"

log "Debug session created successfully!"
echo ""
info "Layout Structure:"
info "┌─────────────────────────────────────────────────────────┐"
info "│  1: File-Explorer  │  0: Main-Editor    │ 2: Utility   │"
info "│                    │                    │               │"
info "├────────────────────┼────────────────────┴───────────────┤"
info "│                    │  3: Terminal                       │"
info "└────────────────────┴────────────────────────────────────┘"
echo ""
info "To attach to debug session: tmux attach-session -t $SESSION_NAME"
info "To kill debug session: tmux kill-session -t $SESSION_NAME"
echo ""

# Optional: Auto-attach
read -p "Attach to debug session now? (y/n): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    log "Attaching to debug session..."
    tmux attach-session -t "$SESSION_NAME"
fi